CREATE DATABASE Bai3_QLLK
GO

USE Bai3_QLLK
GO

CREATE TABLE LOAILK(
    MALOAI VARCHAR(10) PRIMARY KEY NOT NULL, 
    TENLOAI NVARCHAR(100)
)
CREATE TABLE LINHKIEN(
	MALK VARCHAR(10) PRIMARY KEY NOT NULL,
    TENLK NVARCHAR(100) ,
    NGAYSX DATE, 
    TGBH INT,
    MALOAI VARCHAR(10), 
    NSX VARCHAR(10), 
    DVT NVARCHAR(10)
)
CREATE TABLE KHACHHANG(
    MAKH VARCHAR(10) PRIMARY KEY NOT NULL, 
    TENKH NVARCHAR(100), 
    DCHI NVARCHAR(100), 
    DTHOAI VARCHAR(15)
)
CREATE TABLE HOADON(
	MAHD VARCHAR(10) PRIMARY KEY NOT NULL,
    NGAYHD DATE,
    MAKH VARCHAR(10), 
    TONGTIEN DECIMAL(18,0),
    CONSTRAINT FK_HOADON_KHACHHANG FOREIGN KEY  (MAKH) REFERENCES KHACHHANG (MAKH)
)
CREATE TABLE CHITIETHD(
	MAHD VARCHAR(10),
    MALK VARCHAR(10), 
    SOLUONG INT, 
    DONGIA DECIMAL(18,0),
    CONSTRAINT FK_CHITIETHD_LINHKIEN FOREIGN KEY (MALK) REFERENCES LINHKIEN(MALK),
    CONSTRAINT FK_CHITIETHD_HOADON FOREIGN KEY (MAHD) REFERENCES HOADON(MAHD)
)

--Nhập dữ liệu
INSERT INTO LOAILK (MALOAI, TENLOAI)
VALUES
  ('MOU', N'Chuột'),
  ('LAP', N'Máy tính xách tay'),
  ('CPU', N'Bộ xử lý'),
  ('PCX', N'Máy tính để bàn'),
  ('MAI', N'Mainboard');

 INSERT INTO LINHKIEN (MALK, TENLK, NGAYSX, TGBH, MALOAI, NSX, DVT)
VALUES
  ('MOU001', N'Chuột quang có dây', '2014-01-01', 12, 'MOU', 'Genius', N'Cái'),
  ('MOU002', N'Chuột quang không dây', '2015-02-04', 12, 'MOU', 'Mitsumi', N'Cái'),
  ('MOU003', N'Chuột không dây', '2014-04-02', 24, 'MOU', 'Abroad', N'Cái'),
  ('CPU001', N'CPU ADM', '2015-04-05', 24, 'CPU', 'Abroad', N'Cái'),
  ('CPU002', N'CPU INTEL', '2016-02-07', 36, 'CPU', 'Mitsumi', N'Cái'),
  ('CPU003', N'CPU ASUS', '2015-12-08', 36, 'CPU', 'Abroad', 'Cái'),
  ('MAI001', N'Mainboard ASUS', '2015-12-04', 36, 'MAI', 'Mitsumi', N'Cái'),
  ('MAI002', N'Mainboard ATXX', '2016-03-03', 12, 'MAI', 'Mitsumi', N'Cái'),
  ('MAI003', N'Mainboard ACER', '2015-04-14', 12, 'MAI', 'Genius', N'Cái'),
  ('PCX001', N'Acer 20144', '2015-10-19', 12, 'PCX', 'Acer', N'Bộ');

INSERT INTO KHACHHANG (MAKH, TENKH, DCHI, DTHOAI)
VALUES
  ('KH001', N'Nguyễn Thu Tâm', N'Tây Ninh', '0989751723'),
  ('KH002', N'Đinh Bảo Lộc', N'Lâm Đồng', '091823465444'),
  ('KH003', N'Trần Thanh Diệu', N'TP. HCM', '0978123765'),
  ('KH004', N'Hồ Tuấn Thành', N'Hà Nội', '0909456768'),
  ('KH005', N'Huỳnh Kim Ánh', N'Khánh Hòa', '0932987567');
SET DATEFORMAT DMY
INSERT INTO HOADON (MAHD, NGAYHD, MAKH, TONGTIEN)
VALUES
  ('HD001', '01/04/2015', 'KH001', NULL),
  ('HD002', '15/05/2016', 'KH005', NULL),
  ('HD003', '14/06/2016', 'KH004', NULL),
  ('HD004', '03/06/2016', 'KH005', NULL),
  ('HD005', '05/06/2016', 'KH001', NULL),
  ('HD006', '07/07/2016', 'KH003', NULL),
  ('HD007', '12/08/2016', 'KH002', NULL),
  ('HD008', '25/09/2016', 'KH003', NULL);

INSERT INTO CHITIETHD (MAHD, MALK, SOLUONG, DONGIA)
VALUES
  ('HD001', 'MOU001', 2, 1000000),
  ('HD002', 'MOU002', 1, 2000000),
  ('HD003', 'MOU003', 6, 3000000),
  ('HD004', 'CPU001', 5, 500000),
  ('HD005', 'CPU002', 6, 560000),
  ('HD006', 'CPU003', 3, 400000),
  ('HD006', 'MAI001', 1, 200000),
  ('HD007', 'MAI002', 1, 150000),
  ('HD007', 'MAI003', 2, 160000),
  ('HD007', 'MOU001', 1, 1000000),
  ('HD008', 'CPU001', 2, 500000);

SELECT * FROM HOADON
SELECT * FROM CHITIETHD
--UPDATE Tổng Tiền trên mỗi hóa đơn
UPDATE HOADON
SET TONGTIEN = (
    SELECT SUM(CHITIETHD.SOLUONG * CHITIETHD.DONGIA)
    FROM CHITIETHD
    WHERE CHITIETHD.MAHD = HOADON.MAHD
)
--2. Cho biết tên những linh kiện được sản xuất bởi nhà sản xuất Genius và có đơn vị tính là Cái.
SELECT TENLK
FROM LINHKIEN
WHERE NSX = 'Genius' AND DVT = N'Cái'
--3. Cho biết thông tin những linh kiện có thời gian bảo hành là 24 tháng.
SELECT *
FROM LINHKIEN
WHERE TGBH = 24
--4. Hoá đơn nào được lập trong tháng 06/2016?
SELECT *
FROM HOADON
WHERE MONTH(NGAYHD) = 6 AND YEAR(NGAYHD) = 2016
--5. Tên và đơn vị tính của các linh kiện có đơn giá lớn hơn 1.000.000 VND.
SELECT LK.TENLK, LK.DVT
FROM LINHKIEN LK
INNER JOIN CHITIETHD CT ON LK.MALK = CT.MALK
WHERE CT.DONGIA > 1000000
